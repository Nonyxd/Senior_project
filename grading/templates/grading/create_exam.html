{% extends 'grading/base.html' %}

{% block content %}
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<style>
    /* Grid for Choice Selection */
    .grid-container {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(60px, 1fr));
        gap: 8px;
        margin-top: 10px;
        max-height: 300px;
        overflow-y: auto;
        padding: 10px;
        border: 1px solid #ddd;
        background: #f9f9f9;
    }
    .question-item {
        background: #fff;
        padding: 5px;
        border: 1px solid #ccc;
        border-radius: 4px;
        text-align: center;
        font-size: 12px;
    }
    .question-item label { margin-bottom: 2px; display: block; font-weight: bold; }
    .question-item select { width: 100%; padding: 2px; font-size: 11px; }

    /* Custom Styles */
    .form-section {
        background: #fff;
        padding: 20px;
        border: 1px solid #ddd;
        border-radius: 5px;
        margin-bottom: 20px;
        box-shadow: 0 2px 5px rgba(0,0,0,0.05);
    }
    .section-title {
        border-bottom: 2px solid #333;
        padding-bottom: 10px;
        margin-bottom: 20px;
        color: #333;
        font-weight: bold;
    }
    label { font-weight: bold; display: block; margin-bottom: 5px; color: #333; }
    input[type="text"], input[type="number"], input[type="date"], select, .form-control {
        width: 100%;
        padding: 10px;
        box-sizing: border-box;
        border: 1px solid #ccc;
        border-radius: 4px;
        font-size: 14px;
    }
    .btn-save {
        background-color: #2196F3;
        color: white;
        padding: 12px 30px;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        font-size: 16px;
        font-weight: bold;
        width: 100%;
    }
    .btn-save:hover { background-color: #1976D2; }
    
    .mode-switch {
        display: flex;
        gap: 20px;
        margin-bottom: 20px;
        padding: 15px;
        background: #eee;
        border-radius: 5px;
    }
    
    /* Adjust Select2 height */
    .select2-container .select2-selection--single { height: 42px; border: 1px solid #ccc; border-radius: 4px; }
    .select2-container--default .select2-selection--single .select2-selection__rendered { line-height: 40px; }
    .select2-container--default .select2-selection--single .select2-selection__arrow { height: 40px; }

    /* Delete Button in Modal */
    .delete-subject-btn {
        color: #dc3545;
        cursor: pointer;
        padding: 5px 10px;
        font-weight: bold;
        font-size: 1.2em;
        transition: 0.2s;
    }
    .delete-subject-btn:hover {
        background-color: #ffe6e6;
        border-radius: 50%;
    }
</style>

<div class="container" style="font-family: sans-serif; max-width: 900px; margin: 0 auto;">
    
    <div style="background-color: #333; color: white; padding: 15px 20px; display: flex; justify-content: space-between; align-items: center; border-radius: 5px; margin-bottom: 20px;">
        <h2 style="margin: 0;">Create New Exam</h2>
        <a href="{% url 'index' %}" style="color: #ccc; text-decoration: none;">&larr; Back to Dashboard</a>
    </div>

    {% if error %}
    <div style="background-color: #f8d7da; color: #721c24; padding: 15px; margin-bottom: 20px; border: 1px solid #f5c6cb; border-radius: 5px;">
        <strong>Error:</strong> {{ error }}
    </div>
    {% endif %}

    <form method="post" enctype="multipart/form-data" id="createExamForm">
        {% csrf_token %}

        <div class="form-section">
            <h4 class="section-title">1. Select Creation Mode</h4>
            <div class="mode-switch">
                <label style="display: inline-flex; align-items: center; cursor: pointer;">
                    <input type="radio" name="mode" value="manual" checked onclick="toggleMode('manual')" style="width: auto; margin-right: 8px;"> 
                    Manual Input
                </label>
                <label style="display: inline-flex; align-items: center; cursor: pointer;">
                    <input type="radio" name="mode" value="excel" onclick="toggleMode('excel')" style="width: auto; margin-right: 8px;"> 
                    Excel Upload (Auto Fill + Import Roster)
                </label>
            </div>

            <div style="margin-top: 15px;">
                <label>Search Existing Subject (Auto Fill):</label>
                <div style="display: flex; gap: 10px;">
                    <div style="flex-grow: 1;">
                        <select id="subjectSelect" class="searchable-select" style="width: 100%;">
                            <option value="">-- Type to search --</option>
                            {% for sub in existing_subjects %}
                                <option value="{{ sub.subject_code }}|{{ sub.subject_name }}">
                                    {{ sub.subject_code }} - {{ sub.subject_name }}
                                </option>
                            {% endfor %}
                        </select>
                    </div>
                    <button type="button" class="btn btn-outline-danger btn-sm" data-bs-toggle="modal" data-bs-target="#manageSubjectModal" style="white-space: nowrap;">
                        <i class="fas fa-trash-alt"></i> ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£/‡∏•‡∏ö‡∏ß‡∏¥‡∏ä‡∏≤
                    </button>
                </div>
            </div>
        </div>

        <div id="excel-part" class="form-section" style="display: none; border-left: 5px solid #4CAF50;">
            <h4 class="section-title">2. Upload Excel File</h4>
            <p style="color: #666; font-size: 14px;">
                Required Header: <code>SubjectCode</code>, <code>SubjectName</code>, <code>Section</code>, <code>StudentID</code>, <code>FirstName</code>, <code>LastName</code>
            </p>
            <input type="file" id="excelUploader" name="roster_file" accept=".xlsx, .xls" class="form-control" style="padding: 10px; background: #f1f1f1;">
            <small class="text-success" id="uploadStatus"></small>
        </div>

        <div class="form-section">
            <h4 class="section-title">3. Exam Details</h4>
            
            <div style="display: flex; gap: 20px; margin-bottom: 15px;">
                <div style="flex: 1;">
                    <label>Course Code:</label>
                    <input type="text" name="subject_code" id="courseCodeInput" value="{{ saved.subject_code }}" required>
                </div>
                <div style="flex: 2;">
                    <label>Subject Name:</label>
                    <input type="text" name="subject_name" id="examNameInput" value="{{ saved.subject_name }}" required>
                </div>
            </div>

            <div style="display: flex; gap: 20px; margin-bottom: 15px;">
                <div style="flex: 1;">
                    <label>Section:</label>
                    <input type="text" name="section" id="sectionInput" value="{{ saved.section|default:'1' }}">
                </div>
                <div style="flex: 1;">
                    <label>Room:</label>
                    <input type="text" name="room" value="{{ saved.room }}">
                </div>
            </div>

            <hr style="border-top: 1px solid #eee;">

            <div style="display: flex; gap: 20px; margin-bottom: 15px;">
                <div style="flex: 1;">
                    <label>Date:</label>
                    <input type="date" name="exam_date" value="{{ saved.exam_date }}" required>
                </div>
                <div style="flex: 1;">
                    <label>Start Time (24h):</label>
                    <input type="text" class="time-picker" name="start_time" value="{{ saved.start_time|default:'09:00' }}">
                </div>
                <div style="flex: 1;">
                    <label>Duration (Minutes):</label>
                    <input type="number" name="duration_minutes" value="{{ saved.duration_minutes|default:'120' }}">
                </div>
            </div>

            <div>
                <label style="color: #d32f2f;">Total Questions (Limit):</label>
                <input type="number" name="total_questions" value="{{ saved.total_questions|default:100 }}" min="1" max="120">
            </div>
        </div>

        <div id="key-part" class="form-section">
            <h4 class="section-title">4. Answer Key</h4>
            
            <div style="margin-bottom: 15px; padding: 15px; background: #e3f2fd; border-radius: 5px;">
                <label style="color: #1565c0;">Key Pattern:</label>
                <select name="key_type" id="keyType" onchange="toggleKeyInput()" style="border: 2px solid #2196F3; padding: 5px;">
                    <option value="sequential" selected>Auto (A:1-20, B:21-40...)</option>
                    <option value="manual">Manual (Select individually)</option>
                </select>
                <small style="display: block; margin-top: 5px; color: #555;">
                    * Select "Manual" to define specific answers for up to 100 questions.
                </small>
            </div>

            <div id="manualKeyInput" style="display: none;">
                <div class="grid-container">
                    {% for i in range_100 %}
                    <div class="question-item">
                        <label>{{ i }}</label>
                        <select name="q_{{ i }}">
                            <option value="">-</option>
                            <option value="a">A</option>
                            <option value="b">B</option>
                            <option value="c">C</option>
                            <option value="d">D</option>
                            <option value="e">E</option>
                        </select>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>

        <div style="text-align: center; margin-top: 30px; margin-bottom: 50px;">
            <button type="submit" class="btn-save">Save & Create Exam</button>
        </div>

    </form>
</div>

<div class="modal fade" id="manageSubjectModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-dark text-white">
                <h5 class="modal-title"><i class="fas fa-edit"></i> ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ß‡∏¥‡∏ä‡∏≤ (‡∏•‡∏ö‡∏ß‡∏¥‡∏ä‡∏≤‡πÄ‡∏Å‡πà‡∏≤)</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-danger">
                    <i class="fas fa-exclamation-triangle"></i> <b>‡∏Ñ‡∏≥‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô:</b> ‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏ß‡∏¥‡∏ä‡∏≤‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏ô‡∏µ‡πâ ‡∏à‡∏∞‡∏ó‡∏≥‡∏Å‡∏≤‡∏£‡∏•‡∏ö <u>‡∏ó‡∏∏‡∏Å‡∏Å‡∏≤‡∏£‡∏™‡∏≠‡∏ö</u> ‡πÅ‡∏•‡∏∞ <u>‡∏ú‡∏•‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</u> ‡∏†‡∏≤‡∏¢‡πÉ‡∏ï‡πâ‡∏ß‡∏¥‡∏ä‡∏≤‡∏ô‡∏±‡πâ‡∏ô‡πÜ ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
                </div>
                
                <div class="list-group">
                    {% for sub in existing_subjects %}
                    <div class="list-group-item d-flex justify-content-between align-items-center">
                        <div>
                            <span class="fw-bold text-primary">{{ sub.subject_code }}</span>
                            <span class="text-dark mx-2">-</span>
                            <span>{{ sub.subject_name }}</span>
                        </div>
                        <button class="btn btn-outline-danger btn-sm rounded-circle" 
                                onclick="deleteSubject('{{ sub.subject_code }}')" 
                                title="‡∏•‡∏ö‡∏ß‡∏¥‡∏ä‡∏≤‡∏ô‡∏µ‡πâ‡∏ñ‡∏≤‡∏ß‡∏£">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    {% empty %}
                    <div class="text-center p-4 text-muted">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ß‡∏¥‡∏ä‡∏≤</div>
                    {% endfor %}
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á</button>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>

<script>
    $(document).ready(function() {
        // Select2
        $('.searchable-select').select2({ placeholder: "-- Type to search --", allowClear: true });

        // Auto Fill Search
        $('#subjectSelect').on('select2:select', function (e) {
            var val = $(this).val();
            if (val) {
                var parts = val.split('|');
                $('#courseCodeInput').val(parts[0]);
                $('#examNameInput').val(parts[1]);
            }
        });

        // Auto Fill Excel
        $('#excelUploader').on('change', function() {
            var fileData = $(this).prop('files')[0];
            var formData = new FormData();
            formData.append('file', fileData);
            formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');

            $('#uploadStatus').text('Reading file...');
            $('#examNameInput').attr('placeholder', 'Loading...');
            
            $.ajax({
                url: '{% url "api_parse_excel" %}',
                type: 'post',
                data: formData,
                contentType: false,
                processData: false,
                success: function(response){
                    if(response.success){
                        $('#courseCodeInput').val(response.data.subject_code);
                        $('#examNameInput').val(response.data.subject_name);
                        $('#sectionInput').val(response.data.section);
                        
                        $('#uploadStatus').text('File read successfully! Found: ' + response.data.subject_name);
                    } else {
                        alert('Error: ' + response.error);
                        $('#uploadStatus').text('');
                    }
                }
            });
        });
    });

    // Time Picker
    flatpickr(".time-picker", { enableTime: true, noCalendar: true, dateFormat: "H:i", time_24hr: true });

    function toggleMode(mode) {
        if (mode === 'excel') {
            document.getElementById('excel-part').style.display = 'block';
            document.getElementById('key-part').style.display = 'block'; 
        } else {
            document.getElementById('excel-part').style.display = 'none';
            document.getElementById('key-part').style.display = 'block';
        }
    }

    function toggleKeyInput() {
        var type = document.getElementById("keyType").value;
        document.getElementById("manualKeyInput").style.display = (type === "manual") ? "block" : "none";
    }

    // üî•üî• ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏•‡∏ö‡∏ß‡∏¥‡∏ä‡∏≤ (‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÉ‡∏´‡∏°‡πà‡πÄ‡∏õ‡πá‡∏ô SweetAlert2) üî•üî•
    function deleteSubject(code) {
        Swal.fire({
            title: '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö?',
            html: `‡∏Ñ‡∏∏‡∏ì‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏à‡∏∞‡∏•‡∏ö‡∏ß‡∏¥‡∏ä‡∏≤ <strong>${code}</strong><br><br>
                   <span style="color:red; font-size:0.9em;">
                       ‡∏Ñ‡∏≥‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô: ‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏ô‡∏µ‡πâ‡∏à‡∏∞‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏™‡∏≠‡∏ö‡πÅ‡∏•‡∏∞‡∏ú‡∏•‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏†‡∏≤‡∏¢‡πÉ‡∏ï‡πâ‡∏ß‡∏¥‡∏ä‡∏≤‡∏ô‡∏µ‡πâ‡∏´‡∏≤‡∏¢‡πÑ‡∏õ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ!
                   </span>`,
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#d33',
            cancelButtonColor: '#3085d6',
            confirmButtonText: '‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏î‡∏µ‡πã‡∏¢‡∏ß‡∏ô‡∏µ‡πâ',
            cancelButtonText: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å',
            showLoaderOnConfirm: true,
            preConfirm: () => {
                return fetch('{% url "delete_subject_api" %}', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': '{{ csrf_token }}'
                    },
                    body: JSON.stringify({ subject_code: code })
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error(response.statusText)
                    }
                    return response.json()
                })
                .catch(error => {
                    Swal.showValidationMessage(`Request failed: ${error}`)
                })
            },
            allowOutsideClick: () => !Swal.isLoading()
        }).then((result) => {
            if (result.isConfirmed) {
                if (result.value.success) {
                    Swal.fire({
                        icon: 'success',
                        title: '‡∏•‡∏ö‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢',
                        text: result.value.message,
                        timer: 2000,
                        showConfirmButton: false
                    }).then(() => {
                        location.reload(); // ‡∏£‡∏µ‡πÇ‡∏´‡∏•‡∏î‡∏´‡∏ô‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà
                    });
                } else {
                    Swal.fire('Error', result.value.error || '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', 'error');
                }
            }
        });
    }

    // Init
    toggleMode('manual');
    toggleKeyInput();
</script>
{% endblock %}